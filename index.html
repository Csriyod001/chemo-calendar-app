<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î (Chemo Calendar)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 1.5cm;
            }

            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
            .print-page {
                page-break-after: always;
                page-break-inside: avoid;
                display: flex;
                flex-direction: column;
                justify-content: center;
                height: 95%; 
            }
            .print-page:last-child {
                page-break-after: auto;
            }

            .bg-green-100, .bg-red-100, .bg-blue-100, .bg-slate-100, .bg-white, .bg-yellow-100, .bg-slate-200, .bg-green-200, .bg-red-200, .bg-blue-500 {
                background-color: transparent !important;
            }
            * {
                color: #000 !important;
            }
            .border {
                border-color: #999 !important;
            }
            [data-day-type="stop"] {
                border: 2px solid #000 !important;
            }
            [data-day-type="appointment"] {
                border: 3px double #000 !important;
            }
             [data-day-type="take"] {
                border: 1px solid #000 !important;
            }
            .day-checkbox {
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- Database & Constants ---
        const DRUGS_DATA = [
            // Group 1: Continuous
            { id: 1, name: "Abiraterone (Zytiga)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏Ç‡∏ì‡∏∞‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" },
            { id: 2, name: "Axitinib", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏´‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á) ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 3, name: "Ceritinib (Zykadia)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£" },
            { id: 4, name: "Dabrafenib/Trametinib", group: 1, description: "Dabrafenib: ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, Trametinib: ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Ç‡∏ì‡∏∞‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" },
            { id: 5, name: "Enzalutamide (Xtandi)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 6, name: "Erlotinib (Tarceva)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏Ç‡∏ì‡∏∞‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" },
            { id: 7, name: "Everolimus (Afinitor)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 8, name: "Gefitinib (Iressa)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 9, name: "Hydroxyurea (Hydrea)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 10, name: "Imatinib (Glivec)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£" },
            { id: 11, name: "Lapatinib (Tykerb)/letrozole", group: 1, description: "Lapatinib: ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô, Letrozole: ‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á" },
            { id: 12, name: "Lenvatinib", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 13, name: "Olaparib", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 14, name: "Osimertinib (Tagrisso)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" },
            { id: 15, name: "Pazopanib (Votrient)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏Ç‡∏ì‡∏∞‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" },
            { id: 16, name: "Sorafenib (Nexavar)", group: 1, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏Ç‡∏ì‡∏∞‡∏ó‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á" },
            
            // Group 2: On/Off Cycles (Automated)
            { id: 17, name: "Capecitabine adjuvant", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 21 ‡∏ß‡∏±‡∏ô)", autoOn: 14, autoOff: 7 },
            { id: 18, name: "Capecitabine monotherapy", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 21 ‡∏ß‡∏±‡∏ô)", autoOn: 14, autoOff: 7 },
            { id: 19, name: "CAPEOX/XELOX", group: 2, description: "Capecitabine: ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 21 ‡∏ß‡∏±‡∏ô)", autoOn: 14, autoOff: 7 },
            { id: 20, name: "Capecitabine/Docetaxel", group: 2, description: "Capecitabine: ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 21 ‡∏ß‡∏±‡∏ô)", autoOn: 14, autoOff: 7 },
            { id: 21, name: "Cyclophosphamide (Endoxan)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 14 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô", autoOn: 14, autoOff: 7 },
            { id: 22, name: "Etoposide", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 5 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ß‡πâ‡∏ô 16 ‡∏ß‡∏±‡∏ô", autoOn: 5, autoOff: 16 },
            { id: 23, name: "Lapatinib (Tykerb)/capecitabine", group: 2, description: "Lapatinib: ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô, Capecitabine: 14 ‡∏ß‡∏±‡∏ô ‡∏´‡∏¢‡∏∏‡∏î 7 ‡∏ß‡∏±‡∏ô", autoOn: 14, autoOff: 7 },
            { id: 24, name: "Palbociclib (Ibrance)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 21 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 28 ‡∏ß‡∏±‡∏ô)", autoOn: 21, autoOff: 7 },
            { id: 25, name: "Regorafenib (Stivarga)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 21 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 28 ‡∏ß‡∏±‡∏ô)", autoOn: 21, autoOff: 7 },
            { id: 26, name: "Ribociclib (Kisqali)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 21 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 7 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 28 ‡∏ß‡∏±‡∏ô)", autoOn: 21, autoOff: 7 },
            { id: 27, name: "Sunitinib (Sutent)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 4 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (1 ‡∏£‡∏≠‡∏ö = 6 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)", autoOn: 28, autoOff: 14 },
            { id: 28, name: "Tegafur/Gimeracil/Oteracil potassium (TS-ONE)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 28 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 14 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 42 ‡∏ß‡∏±‡∏ô)", autoOn: 28, autoOff: 14 },
            { id: 29, name: "Temozolomide (Temodal)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 5 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ 23 ‡∏ß‡∏±‡∏ô (1 ‡∏£‡∏≠‡∏ö = 28 ‡∏ß‡∏±‡∏ô)", autoOn: 5, autoOff: 23 },
            { id: 30, name: "Trifluridine/Tipiracil (Lonsurf)", group: 2, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1-5 ‡πÅ‡∏•‡∏∞ 8-12 ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 6-7 ‡πÅ‡∏•‡∏∞ 13-28)", isComplex: true },
            
            // Other Groups
            { id: 31, name: "Vinorelbine monotherapy PO", group: 3, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á" },
            { id: 32, name: "Capecitabine CCRT", group: 4, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏â‡∏≤‡∏¢‡∏£‡∏±‡∏á‡∏™‡∏µ" },
            { id: 33, name: "Temozolomide (Temodal) - For Radiation", group: 4, description: "‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏â‡∏≤‡∏¢‡∏£‡∏±‡∏á‡∏™‡∏µ" },
            { id: 34, name: "Freestyle Regimen", group: 5, description: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÄ‡∏≠‡∏á" }
        ];

        // --- Utility Functions ---
        const isWeekend = (date) => { const day = date.getDay(); return day === 0 || day === 6; };
        
        // This function will now check against the state `thaiHolidays`
        const isHoliday = (date, thaiHolidays) => {
            const dateString = dateToYYYYMMDD(date);
            return thaiHolidays.includes(dateString);
        };

        const formatDate = (date) => {
            if (!date) return '';
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d.getTime())) return '';
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };

        const dateToYYYYMMDD = (date) => {
            const d = date instanceof Date ? date : new Date(date);
            if (isNaN(d)) return '';
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // --- React Components ---

        const CalendarHeader = ({ hn, firstName, lastName, drugName, mealInfo, pharmacistNotes }) => (
            <div className="mb-4 border-b pb-4 print:mb-2">
                <h1 className="text-2xl font-bold text-center mb-4 print:text-xl print:mb-2">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</h1>
                <div className="grid grid-cols-2 gap-x-8 text-sm text-gray-800 print:text-xs">
                    <div>
                        <p className="mb-1"><strong>HN:</strong> {hn || ''}</p>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> {firstName || ''} {lastName || ''}</p>
                    </div>
                    <div>
                        <p className="mb-1"><strong>‡∏¢‡∏≤:</strong> {drugName || ''}</p>
                    </div>
                </div>
                <p className="mt-2 print:text-xs"><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤:</strong> {mealInfo || ''}</p>
                {pharmacistNotes && <p className="mt-2 text-sm print:text-xs"><strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</strong> {pharmacistNotes}</p>}
                <p className="text-right text-xs pt-2 text-gray-600 print:hidden"><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:</strong> {formatDate(new Date())}</p>
            </div>
        );

        const CalendarFooter = ({ nextAppointment }) => (
            <div className="mt-4 flex flex-wrap justify-between items-start gap-4 print:mt-2">
                <div className="flex flex-wrap gap-x-4 gap-y-2 text-sm print:hidden">
                    <h4 className="font-bold w-full sm:w-auto">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</h4>
                    <div className="flex items-center"><div className="w-4 h-4 bg-green-100 border border-green-300 mr-2 rounded"></div><span>‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-red-100 border border-red-300 mr-2 rounded"></div><span>‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-blue-100 border border-blue-300 mr-2 rounded"></div><span>‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏¢‡∏≤</span></div>
                    <div className="flex items-center"><div className="w-4 h-4 bg-slate-100 border border-slate-300 mr-2 rounded"></div><span>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span></div>
                </div>
                {nextAppointment && (
                <div className="text-right p-2 bg-yellow-100 border border-yellow-300 rounded-md print:border-2 print:border-black print:p-1">
                    <p className="font-bold text-yellow-800 print:text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</p>
                    <p className="text-lg font-semibold text-red-600 print:text-base">{formatDate(nextAppointment)}</p>
                </div>
                )}
            </div>
        );

        const DayCell = ({ dayOfMonth, dayData, mealRelationText, isWeekendOrHoliday }) => {
            let bgColor = isWeekendOrHoliday ? 'bg-slate-100' : 'bg-white';
            let textColor = isWeekendOrHoliday ? 'text-slate-500' : 'text-black';

            if (!dayData) {
                return (
                    <div className={`border rounded-md p-1 text-sm h-28 flex flex-col ${bgColor} ${textColor} print:h-auto print:min-h-[2.8cm]`}>
                        <div className="text-right font-bold">{dayOfMonth}</div>
                    </div>
                );
            }
            
            if (dayData.type === 'take') bgColor = 'bg-green-100';
            if (dayData.type === 'stop') bgColor = 'bg-red-100';
            if (dayData.type === 'appointment') bgColor = 'bg-blue-100 text-blue-800';

            return (
                <div data-day-type={dayData.type} className={`border rounded-md p-1 text-sm h-28 flex flex-col ${bgColor} ${textColor} print:h-auto print:min-h-[2.8cm]`}>
                    <div className="flex justify-between font-bold">
                        <span>{dayData.type === 'take' ? mealRelationText : ''}</span>
                        <span>{dayOfMonth}</span>
                    </div>

                    {dayData.type === 'appointment' && (
                        <div className="flex-grow flex items-center justify-center font-bold">
                            ‡∏ß‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏¢‡∏≤
                        </div>
                    )}

                    {dayData.type === 'stop' && (
                        <div className="mt-1 space-y-1 text-left flex-grow flex items-center">
                            <div className="w-4 h-4 border border-current mr-2 day-checkbox"></div>
                            <span className="font-bold">‡∏´‡∏¢‡∏∏‡∏î</span>
                        </div>
                    )}
                    
                    {dayData.type === 'take' && (
                         <div className="mt-1 space-y-1 text-left flex-grow">
                            {Object.entries(dayData.timings).map(([time, data]) => {
                                if (data.checked && data.pills) {
                                    const label = { morning: '‡πÄ‡∏ä‡πâ‡∏≤', noon: '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', evening: '‡πÄ‡∏¢‡πá‡∏ô', bedtime: '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' }[time];
                                    return (
                                        <div key={time} className="flex items-center">
                                            <div className="w-4 h-4 border border-current mr-2 day-checkbox"></div>
                                            <span>{label}</span>
                                            <span className="ml-auto">{data.pills} ‡πÄ‡∏°‡πá‡∏î</span>
                                        </div>
                                    );
                                }
                                return null;
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const Calendar = ({ month, year, markedDays, mealRelationText, thaiHolidays }) => {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const monthName = new Date(year, month).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

            const calendarGrid = [];
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.push(<div key={`empty-${i}`} className="border rounded-md p-1"></div>); }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateString = dateToYYYYMMDD(currentDate);
                const mark = markedDays.find(d => d.date === dateString);
                
                calendarGrid.push(
                    <DayCell 
                        key={day}
                        dayOfMonth={day}
                        dayData={mark}
                        mealRelationText={mealRelationText}
                        isWeekendOrHoliday={isWeekend(currentDate) || isHoliday(currentDate, thaiHolidays)}
                    />
                );
            }

            return (
                <div className="p-4 bg-white rounded-lg shadow-none print:p-0">
                    <h3 className="text-xl font-bold text-center mb-4 print:text-lg print:mb-2">{monthName}</h3>
                    <div className="grid grid-cols-7 gap-2 text-center font-semibold mb-2 print:text-sm print:gap-1">
                        <div className="text-red-500">‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div className="text-red-500">‡∏™</div>
                    </div>
                    <div className="grid grid-cols-7 gap-1">{calendarGrid}</div>
                </div>
            );
        };
        
        const ChemoCalendarApp = () => {
            // --- STATE MANAGEMENT ---
            const [hn, setHn] = useState('');
            const [firstName, setFirstName] = useState('');
            const [lastName, setLastName] = useState('');
            const [selectedDrugId, setSelectedDrugId] = useState('');
            const [formData, setFormData] = useState({});
            const [freestyleConfig, setFreestyleConfig] = useState({ subDrugId: '', onDays: '', offDays: '' });
            const [calendarDays, setCalendarDays] = useState([]);
            const [nextAppointment, setNextAppointment] = useState(null);
            const [error, setError] = useState('');
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [monthsToPrint, setMonthsToPrint] = useState([]);
            const [appointmentDateInput, setAppointmentDateInput] = useState('');
            const [pharmacistNotes, setPharmacistNotes] = useState('');
            
            // --- NEW STATE FOR HOLIDAYS ---
            const [thaiHolidays, setThaiHolidays] = useState([]);
            const [holidaysLoading, setHolidaysLoading] = useState(true);

            // --- API KEY - PLEASE REPLACE WITH YOUR OWN ---
            const API_KEY = 'AIzaSyAyV7R_yezXZEv-U6wS9xMYuDQbsS6pknQ'; // <-- üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            const CALENDAR_ID = 'th.th#holiday@group.v.calendar.google.com';

            // --- FETCH HOLIDAYS FROM GOOGLE CALENDAR API ---
            useEffect(() => {
                const fetchHolidays = async () => {
                    setHolidaysLoading(true);
                    const currentYear = new Date().getFullYear();
                    // Fetch for current and next year for better coverage
                    const timeMin = `${currentYear}-01-01T00:00:00Z`;
                    const timeMax = `${currentYear + 1}-12-31T23:59:59Z`;
                    
                    const url = `https://www.googleapis.com/calendar/v3/calendars/${CALENDAR_ID}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&maxResults=250`;

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`Google API Error: ${response.statusText}`);
                        }
                        const data = await response.json();
                        const holidayDates = data.items.map(item => item.start.date);
                        setThaiHolidays(holidayDates);
                    } catch (err) {
                        console.error("Failed to fetch Thai holidays:", err);
                        setError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key");
                    } finally {
                        setHolidaysLoading(false);
                    }
                };

                if(API_KEY === 'YOUR_GOOGLE_CALENDAR_API_KEY') {
                    setError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Calendar API Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î");
                    setHolidaysLoading(false);
                } else {
                    fetchHolidays();
                }
            }, []);


            const selectedDrug = useMemo(() => DRUGS_DATA.find(d => d.id === parseInt(selectedDrugId)), [selectedDrugId]);
            const groupType = selectedDrug?.group;
            
            const resetFullForm = useCallback(() => {
                setHn('');
                setFirstName('');
                setLastName('');
                setSelectedDrugId(''); 
                setPharmacistNotes('');
            }, []);

            const resetRegimenForm = useCallback(() => {
                setFormData({ 
                    mealRelations: { before: false, after: true, with: false }, 
                    timings: { morning: { checked: false, pills: '' }, noon: { checked: false, pills: '' }, evening: { checked: false, pills: '' }, bedtime: { checked: false, pills: '' } }, 
                    startDate: '', endDate: '', numberOfDays: '', on: '', off: '', cycles: '' 
                });
                setFreestyleConfig({ subDrugId: '', onDays: '', offDays: '' });
                setCalendarDays([]);
                setNextAppointment(null);
                setMonthsToPrint([]);
                setAppointmentDateInput('');
            }, []);
            
            useEffect(() => {
                resetRegimenForm();
                if (selectedDrug) {
                    if (selectedDrug.group === 2 && (selectedDrug.autoOn || selectedDrug.autoOff)) {
                        setFormData(prev => ({ ...prev, on: selectedDrug.autoOn || '', off: selectedDrug.autoOff || '' }));
                    }
                }
            }, [selectedDrugId, resetRegimenForm]);
            
            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                const mealRelationKeys = ['before', 'after', 'with'];
                const timingKeys = ['morning', 'noon', 'evening', 'bedtime'];

                if (name.startsWith('freestyle')) {
                    const keyMap = { freestyleSubDrugId: 'subDrugId', freestyleOnDays: 'onDays', freestyleOffDays: 'offDays' };
                    setFreestyleConfig(prev => ({...prev, [keyMap[name]]: value}));
                } else if (type === 'checkbox') {
                    if (mealRelationKeys.includes(name)) {
                        setFormData(prev => ({ ...prev, mealRelations: { ...prev.mealRelations, [name]: checked }}));
                    } else if (timingKeys.includes(name)) { // Handle timing checkbox
                        setFormData(prev => {
                            const newTimings = { ...prev.timings };
                            newTimings[name].checked = checked;
                            if (!checked) { // Clear pills if unchecked
                                newTimings[name].pills = '';
                            }
                            return { ...prev, timings: newTimings };
                        });
                    }
                } else if (e.target.dataset.timing) { // Handle timing pill input
                    const time = e.target.dataset.timing;
                    setFormData(prev => ({
                        ...prev,
                        timings: { ...prev.timings, [time]: { ...prev.timings[time], pills: value } }
                    }));
                }
                else {
                    setFormData(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleDayClick = (date) => {
                 if (groupType === 4) {
                    const dateString = dateToYYYYMMDD(date);
                     if (isWeekend(date) || isHoliday(date, thaiHolidays)) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'); return; }
                    setCalendarDays(prev => {
                        const existing = prev.find(d => d.date === dateString);
                        const newDays = existing ? prev.filter(d => d.date !== dateString) : [...prev, { date: dateString, type: 'take', timings: formData.timings }];
                        return newDays.sort((a,b) => a.date.localeCompare(b.date));
                    });
                }
            };
            
            const getMealInfoText = () => {
                const timingsText = Object.entries(formData.timings || {})
                    .filter(([_, timingData]) => timingData.checked && parseInt(timingData.pills) > 0)
                    .map(([time, timingData]) => {
                        const label = { morning: '‡πÄ‡∏ä‡πâ‡∏≤', noon: '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', evening: '‡πÄ‡∏¢‡πá‡∏ô', bedtime: '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' }[time];
                        return `${label} ${timingData.pills} ‡πÄ‡∏°‡πá‡∏î`;
                    })
                    .join(', ');

                const relations = Object.keys(formData.mealRelations || {})
                    .filter(key => formData.mealRelations[key])
                    .map(key => ({ before: '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', after: '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', with: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£' }[key]))
                    .join(' ');
                
                return `${timingsText} ${relations}`.trim();
            };

            const getMealRelationText = () => {
                 return Object.keys(formData.mealRelations || {})
                    .filter(key => formData.mealRelations[key])
                    .map(key => ({ before: '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', after: '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', with: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£' }[key]))
                    .join(' ');
            }
            
            const getDrugNameForDisplay = () => {
                if (!selectedDrug) return 'N/A';
                if (groupType === 5 && freestyleConfig.subDrugId) {
                    const subDrug = DRUGS_DATA.find(d => d.id === parseInt(freestyleConfig.subDrugId));
                    return `${selectedDrug.name} (${subDrug?.name || ''})`;
                }
                return selectedDrug.name;
            };

            useEffect(() => {
                if (!hn.trim() || !firstName.trim() || !lastName.trim() || !selectedDrugId) {
                    setCalendarDays([]);
                    setMonthsToPrint([]);
                    // Don't clear API error here
                    // setError(''); 
                    return;
                }
                
                let regimenDays = [];
                const { startDate, endDate, numberOfDays, on, off, cycles } = formData;
                
                try {
                    setError(prev => prev.includes("API Key") ? prev : ''); // Keep API key error
                    if (groupType !== 4) {
                        switch (groupType) {
                            case 1: 
                                if (!startDate || !numberOfDays) throw new Error("Incomplete");
                                let current = new Date(startDate);
                                for (let i = 0; i < parseInt(numberOfDays); i++) {
                                    regimenDays.push({ date: dateToYYYYMMDD(current), type: 'take', timings: formData.timings });
                                    current.setDate(current.getDate() + 1);
                                }
                                break;
                            case 3: 
                                if (!startDate || !endDate) throw new Error("Incomplete");
                                let currentGroup3 = new Date(startDate);
                                let endGroup3 = new Date(endDate);
                                endGroup3.setHours(23, 59, 59, 999);
                                while (currentGroup3 <= endGroup3) { 
                                    regimenDays.push({ date: dateToYYYYMMDD(currentGroup3), type: 'take', timings: formData.timings }); 
                                    currentGroup3.setDate(currentGroup3.getDate() + 1); 
                                    if (regimenDays.length > 365 * 5) break;
                                }
                                break;
                            case 2:
                                if (selectedDrug.isComplex) {
                                    if (!startDate || !cycles) throw new Error("Incomplete");
                                    let cycleStartComplex = new Date(startDate);
                                    for (let i = 0; i < parseInt(cycles); i++) {
                                        for (let d = 0; d < 5; d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStartComplex), type: 'take', timings: formData.timings }); cycleStartComplex.setDate(cycleStartComplex.getDate() + 1); }
                                        for (let d = 0; d < 2; d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStartComplex), type: 'stop' }); cycleStartComplex.setDate(cycleStartComplex.getDate() + 1); }
                                        for (let d = 0; d < 5; d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStartComplex), type: 'take', timings: formData.timings }); cycleStartComplex.setDate(cycleStartComplex.getDate() + 1); }
                                        for (let d = 0; d < 16; d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStartComplex), type: 'stop' }); cycleStartComplex.setDate(cycleStartComplex.getDate() + 1); }
                                    }
                                } else {
                                    if (!startDate || !on || !off || !cycles) throw new Error("Incomplete");
                                    let cycleStart = new Date(startDate);
                                    for (let i = 0; i < parseInt(cycles); i++) {
                                        for (let d = 0; d < parseInt(on); d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStart), type: 'take', timings: formData.timings }); cycleStart.setDate(cycleStart.getDate() + 1); }
                                        for (let d = 0; d < parseInt(off); d++) { regimenDays.push({ date: dateToYYYYMMDD(cycleStart), type: 'stop' }); cycleStart.setDate(cycleStart.getDate() + 1); }
                                    }
                                }
                                break;
                            case 5:
                                const { subDrugId, onDays, offDays } = freestyleConfig;
                                if (!subDrugId || !onDays || !offDays || !startDate) throw new Error("Incomplete");
                                let fsCurrent = new Date(startDate);
                                let fsEnd = endDate ? new Date(endDate) : null;
                                if (fsEnd) fsEnd.setHours(23, 59, 59, 999);
                                while (!fsEnd || fsCurrent <= fsEnd) {
                                    for (let i = 0; i < parseInt(onDays) && (!fsEnd || fsCurrent <= fsEnd); i++) { regimenDays.push({ date: dateToYYYYMMDD(fsCurrent), type: 'take', timings: formData.timings }); fsCurrent.setDate(fsCurrent.getDate() + 1); }
                                    for (let i = 0; i < parseInt(offDays) && (!fsEnd || fsCurrent <= fsEnd); i++) { regimenDays.push({ date: dateToYYYYMMDD(fsCurrent), type: 'stop' }); fsCurrent.setDate(fsCurrent.getDate() + 1); }
                                    if (regimenDays.length > 365 * 5) break;
                                }
                                if (fsEnd) { regimenDays = regimenDays.filter(d => new Date(d.date) <= fsEnd); }
                                break;
                        }
                    }

                    if (appointmentDateInput) {
                        const apptDate = new Date(appointmentDateInput);
                        if (!isNaN(apptDate)) {
                            regimenDays.push({ date: dateToYYYYMMDD(apptDate), type: 'appointment' });
                            setNextAppointment(apptDate);
                        } else {
                            setNextAppointment(null);
                        }
                    } else {
                        setNextAppointment(null);
                    }

                    setCalendarDays(regimenDays.sort((a, b) => a.date.localeCompare(b.date)));

                } catch (e) {
                    if (e.message !== "Incomplete") setError(e.message);
                    setCalendarDays([]);
                }
            }, [hn, firstName, lastName, selectedDrugId, formData, freestyleConfig, appointmentDateInput]);
            
            useEffect(() => {
                const printMonths = [];
                if (calendarDays.length > 0) {
                    const allDates = calendarDays.map(d => new Date(d.date));
                    const calStartDate = new Date(Math.min.apply(null, allDates));
                    const calEndDate = new Date(Math.max.apply(null, allDates));
                    let currentMonth = new Date(calStartDate.getFullYear(), calStartDate.getMonth(), 1);
                    const lastMonth = new Date(calEndDate.getFullYear(), calEndDate.getMonth(), 1);
                    while(currentMonth <= lastMonth) {
                        printMonths.push({month: currentMonth.getMonth(), year: currentMonth.getFullYear()});
                        currentMonth.setMonth(currentMonth.getMonth() + 1);
                    }
                }
                setMonthsToPrint(printMonths);
            }, [calendarDays]);


            const handlePrint = () => { setTimeout(() => { window.print(); }, 100); };
            const changeMonth = (delta) => {
              let d = new Date(year, month);
              d.setMonth(d.getMonth() + delta);
              setMonth(d.getMonth()); setYear(d.getFullYear());
            };

            const freestyleDrugOptions = useMemo(() => DRUGS_DATA.filter(d => d.group === 1 || d.group === 2), []);
            
            const pillsPerDay = useMemo(() => {
                const { timings } = formData;
                if (!timings) return 0;
                return Object.values(timings).reduce((sum, timingData) => sum + (timingData.checked ? (parseInt(timingData.pills) || 0) : 0), 0);
            }, [formData.timings]);

            const totalDoseGroup1 = useMemo(() => { if (groupType === 1 && pillsPerDay > 0 && formData.numberOfDays) { const n=parseInt(formData.numberOfDays); return !isNaN(n)?pillsPerDay*n:0; } return 0; }, [pillsPerDay, formData.numberOfDays, groupType]);
            const totalDoseGroup2 = useMemo(() => { if (groupType === 2 && pillsPerDay > 0 && formData.on && formData.cycles) { const o=parseInt(formData.on), c=parseInt(formData.cycles); return !isNaN(o)&&!isNaN(c)?pillsPerDay*o*c:0; } return 0; }, [pillsPerDay, formData.on, formData.cycles, groupType]);
            const totalDoseGroup3 = useMemo(() => { if (groupType === 3 && pillsPerDay > 0 && formData.startDate && formData.endDate) { try { const s=new Date(formData.startDate), e=new Date(formData.endDate); if(s>e)return 0; return pillsPerDay*(Math.ceil(Math.abs(e-s)/(1e3*60*60*24))+1); } catch (e){return 0;} } return 0; }, [pillsPerDay, formData.startDate, formData.endDate, groupType]);
            const totalDoseFreestyle = useMemo(() => { if(groupType!==5||pillsPerDay<=0||!formData.startDate||!freestyleConfig.onDays||!freestyleConfig.offDays)return 0; try{ let takeDaysCount=0,c=new Date(formData.startDate),f=formData.endDate?new Date(formData.endDate):null; if(f)f.setHours(23,59,59,999); const on=parseInt(freestyleConfig.onDays),off=parseInt(freestyleConfig.offDays)||0; if(isNaN(on)||on<=0)return 0; while(!f||c<=f){for(let i=0;i<on&&(!f||c<=f);i++){takeDaysCount++;c.setDate(c.getDate()+1);} for(let i=0;i<off&&(!f||c<=f);i++){c.setDate(c.getDate()+1);}} return takeDaysCount*pillsPerDay; }catch(e){return 0;} }, [groupType, pillsPerDay, formData.startDate, formData.endDate, freestyleConfig.onDays, freestyleConfig.offDays]);
            
            const totalPills = useMemo(() => {
                switch (groupType) {
                    case 1: return totalDoseGroup1;
                    case 2: return totalDoseGroup2;
                    case 3: return totalDoseGroup3;
                    case 5: return totalDoseFreestyle;
                    default: return 0;
                }
            }, [groupType, totalDoseGroup1, totalDoseGroup2, totalDoseGroup3, totalDoseFreestyle]);
            
            const isPatientInfoFilled = hn.trim() && firstName.trim() && lastName.trim();
            const isDrugSelected = !!selectedDrugId;

            return (
              <div>
                <header className="bg-white shadow-md p-4 no-print">
                  <div className="container mx-auto"><h1 className="text-3xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ö‡∏≥‡∏ö‡∏±‡∏î</h1></div>
                </header>
                <main className="container mx-auto p-4">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <div className="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg no-print h-fit">
                          <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏≤</h2>
                            <button onClick={resetFullForm} className="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition-colors">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                          </div>
                          {error && <p className="text-red-500 text-sm mb-4 bg-red-100 p-2 rounded">{error}</p>}
                          {holidaysLoading && <p className="text-blue-500 text-sm mb-4 bg-blue-100 p-2 rounded">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î...</p>}
                          
                          <fieldset>
                            <div className="mb-4">
                              <label className="block text-gray-700 font-semibold mb-2">HN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                              <input type="text" value={hn} onChange={(e) => setHn(e.target.value)} className="w-full p-2 border rounded" />
                            </div>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                              <div>
                                  <label className="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                                  <input type="text" value={firstName} onChange={(e) => setFirstName(e.target.value)} className="w-full p-2 border rounded" />
                              </div>
                              <div>
                                  <label className="block text-gray-700 font-semibold mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                  <input type="text" value={lastName} onChange={(e) => setLastName(e.target.value)} className="w-full p-2 border rounded" />
                              </div>
                            </div>
                          </fieldset>
                          
                          {!isPatientInfoFilled && (
                            <div className="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-700">
                                <p className="font-bold">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
                                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (HN, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
                            </div>
                          )}

                          <fieldset disabled={!isPatientInfoFilled} className="disabled:opacity-50 disabled:cursor-not-allowed mt-4 space-y-4">
                            <div>
                                <label className="block text-gray-700 font-semibold mb-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏™‡∏π‡∏ï‡∏£‡∏¢‡∏≤</label>
                                <select value={selectedDrugId} onChange={(e) => setSelectedDrugId(e.target.value)} className="w-full p-2 border rounded">
                                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                    {DRUGS_DATA.map(drug => <option key={drug.id} value={drug.id}>‡∏Å‡∏•‡∏∏‡πà‡∏° {drug.group}: {drug.name}</option>)}
                                </select>
                            </div>
                            
                            {isPatientInfoFilled && !isDrugSelected && (
                                <div className="p-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-700">
                                    <p className="font-bold">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
                                    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤/‡∏™‡∏π‡∏ï‡∏£‡∏¢‡∏≤</p>
                                </div>
                            )}
                            
                            {selectedDrug && (
                              <div className="space-y-4">
                                  <div>
                                    <label className="block text-gray-700 font-semibold mb-2">2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏Å‡∏•‡∏∏‡πà‡∏° {groupType})</label>
                                    <div className="text-sm text-blue-800 bg-blue-50 p-3 rounded-md mb-3 border border-blue-200">
                                        <h4 className="font-bold">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤:</h4>
                                        <p>{selectedDrug.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
                                    </div>
                                    
                                    {groupType === 5 && (
                                        <div className="p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                                            <label className="block text-sm font-semibold text-indigo-800 mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Freestyle</label>
                                            <div className="mb-2">
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£</label>
                                                <select name="freestyleSubDrugId" value={freestyleConfig.subDrugId} onChange={handleInputChange} className="w-full p-2 border rounded">
                                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏ï‡∏£ --</option>
                                                    {freestyleDrugOptions.map(drug => <option key={`fs-${drug.id}`} value={drug.id}>‡∏Å‡∏•‡∏∏‡πà‡∏° {drug.group}: {drug.name}</option>)}
                                                </select>
                                            </div>
                                            <div className="mb-2">
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                                <input type="date" name="startDate" value={formData.startDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                            </div>
                                            <div className="mb-2">
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                                <input type="date" name="endDate" value={formData.endDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ó‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                                                    <input type="number" name="freestyleOnDays" value={freestyleConfig.onDays} onChange={handleInputChange} className="p-2 border rounded w-full" min="0" onWheel={(e) => e.target.blur()} />
                                                </div>
                                                <div>
                                                    <label className="text-sm font-medium text-gray-600 mb-1 block">‡πÄ‡∏ß‡πâ‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                                                    <input type="number" name="freestyleOffDays" value={freestyleConfig.offDays} onChange={handleInputChange} className="p-2 border rounded w-full" min="0" onWheel={(e) => e.target.blur()} />
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {groupType === 1 && <>
                                        <div className="mb-2">
                                            <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                            <input type="date" name="startDate" value={formData.startDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                        </div>
                                        <div className="mb-2">
                                            <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</label>
                                            <input type="number" name="numberOfDays" value={formData.numberOfDays || ''} onChange={handleInputChange} className="p-2 border rounded w-full" min="0" onWheel={(e) => e.target.blur()} />
                                        </div>
                                    </>}
                                    {groupType === 3 && <>
                                        <div className="mb-2">
                                            <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                            <input type="date" name="startDate" value={formData.startDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                        </div>
                                        <div className="mb-2">
                                            <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                            <input type="date" name="endDate" value={formData.endDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                        </div>
                                    </>}
                                    {groupType === 2 && <>
                                        <div className="mb-2">
                                            <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                            <input type="date" name="startDate" value={formData.startDate || ''} onChange={handleInputChange} className="p-2 border rounded w-full" />
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div>
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏ó‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)</label>
                                                <input type="number" name="on" value={formData.on || ''} onChange={handleInputChange} className="p-2 border rounded w-full" readOnly={selectedDrug && !!selectedDrug.autoOn} min="0" onWheel={(e) => e.target.blur()} />
                                            </div>
                                            <div>
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏´‡∏¢‡∏∏‡∏î (‡∏ß‡∏±‡∏ô)</label>
                                                <input type="number" name="off" value={formData.off || ''} onChange={handleInputChange} className="p-2 border rounded w-full" readOnly={selectedDrug && !!selectedDrug.autoOff} min="0" onWheel={(e) => e.target.blur()} />
                                            </div>
                                            <div>
                                                <label className="text-sm font-medium text-gray-600 mb-1 block">‡∏£‡∏≠‡∏ö</label>
                                                <input type="number" name="cycles" value={formData.cycles || ''} onChange={handleInputChange} className="p-2 border rounded w-full" min="0" onWheel={(e) => e.target.blur()} />
                                            </div>
                                        </div>
                                    </>}
                                    { groupType === 4 && <p className="text-sm text-center bg-blue-100 p-2 rounded">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ö‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</p> }
                                  </div>
                                  
                                  <div className="mt-4 p-3 bg-slate-50 rounded-md border">
                                      <label className="block text-gray-700 font-semibold mb-2">3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤</label>
                                      <div className="mb-3">
                                          <p className="text-sm font-medium text-gray-600 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</p>
                                          <div className="grid grid-cols-3 gap-2 text-sm">
                                              {[{key: 'before', label: '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}, {key: 'after', label: '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}, {key: 'with', label: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}].map(item => (
                                                 <label key={item.key} className="flex items-center space-x-2 p-2 bg-white rounded-md border cursor-pointer">
                                                      <input type="checkbox" name={item.key} checked={formData.mealRelations?.[item.key] || false} onChange={handleInputChange} />
                                                      <span>{item.label}</span>
                                                 </label>
                                              ))}
                                          </div>
                                      </div>
                                      <hr className="my-3"/>
                                      <div>
                                           <p className="text-sm font-medium text-gray-600 mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</p>
                                           <div className="grid grid-cols-2 gap-4 text-sm">
                                              {['morning', 'noon', 'evening', 'bedtime'].map(time => (
                                                 <div key={time} className="flex items-center space-x-2">
                                                      <input 
                                                          type="checkbox" 
                                                          name={time} 
                                                          checked={formData.timings?.[time]?.checked || false} 
                                                          onChange={handleInputChange} 
                                                          id={`checkbox-${time}`}
                                                          className="h-4 w-4 rounded"
                                                      />
                                                      <label htmlFor={`checkbox-${time}`} className="flex-1 text-gray-700">{{ morning: '‡πÄ‡∏ä‡πâ‡∏≤', noon: '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', evening: '‡πÄ‡∏¢‡πá‡∏ô', bedtime: '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô' }[time]}</label>
                                                      <input 
                                                          type="number" 
                                                          data-timing={time}
                                                          value={formData.timings?.[time]?.pills || ''} 
                                                          onChange={handleInputChange} 
                                                          className="p-1 border rounded w-20"
                                                          placeholder="‡πÄ‡∏°‡πá‡∏î"
                                                          disabled={!formData.timings?.[time]?.checked}
                                                          min="0"
                                                          onWheel={(e) => e.target.blur()}
                                                      />
                                                 </div>
                                              ))}
                                          </div>
                                      </div>
                                  </div>

                                  {totalPills > 0 && (
                                      <div className="mt-4 p-2 bg-green-100 rounded-md text-center text-green-800 font-semibold">
                                          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡πá‡∏î‡∏¢‡∏≤: {totalPills}
                                      </div>
                                  )}

                                  <div className="mt-4">
                                      <label className="block text-gray-700 font-semibold mb-2">4. ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏¢‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                      <input 
                                          type="date" 
                                          name="appointmentDateInput" 
                                          value={appointmentDateInput} 
                                          onChange={(e) => setAppointmentDateInput(e.target.value)} 
                                          className="p-2 border rounded w-full" 
                                      />
                                      <p className="text-xs text-gray-500 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</p>
                                  </div>

                                  <div className="mt-4">
                                      <label className="block text-gray-700 font-semibold mb-2">5. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                      <textarea
                                          value={pharmacistNotes}
                                          onChange={(e) => setPharmacistNotes(e.target.value)}
                                          className="w-full p-2 border rounded"
                                          rows="3"
                                          placeholder="‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£..."
                                      />
                                  </div>
                              </div>
                            )}
                          </fieldset>
                      </div>

                      <div className="lg:col-span-2">
                        <div className="bg-white p-4 rounded-lg shadow-lg no-print">
                           <CalendarHeader hn={hn} firstName={firstName} lastName={lastName} drugName={getDrugNameForDisplay()} mealInfo={getMealInfoText()} pharmacistNotes={pharmacistNotes} />
                           <div className="flex justify-between items-center mb-4">
                              <button onClick={() => changeMonth(-1)} className="no-print bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">&lt; ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                              <button onClick={() => changeMonth(1)} className="no-print bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &gt;</button>
                           </div>
                           <Calendar month={month} year={year} markedDays={calendarDays} onDayClick={handleDayClick} isSelectable={groupType === 4} mealRelationText={getMealRelationText()} thaiHolidays={thaiHolidays} />
                        </div>
                        {calendarDays.length > 0 && <div className="text-center mt-4 no-print"><button onClick={handlePrint} className="bg-purple-600 text-white font-bold py-2 px-6 rounded-md hover:bg-purple-700 transition">‡∏û‡∏¥‡∏°‡∏û‡πå</button></div>}
                      </div>
                  </div>
                </main>

                <div className="hidden print:block" id="print-container">
                    {monthsToPrint.map((date, index) => (
                        <div key={`${date.year}-${date.month}`} className="print-page">
                             <CalendarHeader hn={hn} firstName={firstName} lastName={lastName} drugName={getDrugNameForDisplay()} mealInfo={getMealInfoText()} pharmacistNotes={pharmacistNotes} />
                             <Calendar 
                                month={date.month} 
                                year={date.year}
                                markedDays={calendarDays}
                                onDayClick={() => {}} 
                                isSelectable={false} 
                                mealRelationText={getMealRelationText()}
                                thaiHolidays={thaiHolidays}
                            />
                            {index === monthsToPrint.length - 1 && <CalendarFooter nextAppointment={nextAppointment} />}
                        </div>
                    ))}
                </div>

              </div>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<ChemoCalendarApp />);
    </script>
</body>
</html>

